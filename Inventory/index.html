<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>US175 Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- <script src="../js/jsrsasign-latest-all-min.js"></script> -->
  <!-- <script src="../js/verifier.js"></script> -->
  <!-- <script src="js/userprofile.js"></script> -->
  <link rel="manifest" href="public/manifest.webmanifest">
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-iphone-retina.png">
  <link rel="stylesheet" type="text/css" href="../vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="../fonts/font-awesome-4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="../vendor/animate/animate.css">
  <link rel="stylesheet" type="text/css" href="../vendor/select2/select2.min.css">
  <link rel="stylesheet" type="text/css" href="../vendor/perfect-scrollbar/perfect-scrollbar.css">
  <link rel="stylesheet" type="text/css" href="../css/util.css">
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <style>
	.update-transition {
        	transition: all 100ms ease-out;
	}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">
      <img src="icon.svg" width="30" height="30" class="d-inline-block align-top" alt="us175-price-archive-icon">
      US175
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto align-items-center">
        <li class="nav-item active">
          <a class="nav-link text-nowrap" href="https://test.us175.com/Inventory/">Inventory <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://test.us175.com/PriceArchive/">Price Archive</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gallery.us175.com/">Gallery</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://inv.us175.com/wantlist">Wantlist</a>
        </li>
        <li class="mb-3 mb-lg-0">
          <button class="btn btn-outline-success my-2 my-sm-0 w-100" type="button" data-toggle="modal" data-target="#staticBackdropAddInventory">Update Inventory</button>
        </li>
      </ul>
      <!-- Form for searching existing transactions -->
      <form id="existingForm" class="form-inline">
        <!-- <input type="date" id="startDate" class="form-control mb-2 mr-sm-2"> -->
        <!-- <input type="date" id="endDate" class="form-control mb-2 mr-sm-2"> -->
        <!-- Default checked -->
        <!--
        <div class="custom-control custom-switch" id="searchToggle">
          <input type="checkbox" class="custom-control-input" id="customSwitch1" onchange="toggleSetPlayer()" checked>
          <label class="custom-control-label" for="customSwitch1"></label>
        </div>
        -->
        <input class="queryInput form-control mb-2 mr-sm-2" type="text" id="queryYear" name="queryYear" title="Four digit year" pattern="^(20[0-9][0-9])$|(19[0-9][0-9])$" placeholder="2001" aria-required="true">
        <select class="custom-select form-control mb-2 mr-sm-2 flex-grow-1" id="setSearchList" required aria-required="true">
          <option selected value="">Select set...</option>
        </select>
        <select class="custom-select form-control mb-2 mr-sm-2 flex-grow-1" id="subsetSearchList">
          <option selected value="">Select subset...</option>
        </select>
        <input class="form-control mb-2 mr-sm-2" type="number" id="qty" name="qty" min="0" value="0" title="quantity">
        <button type="submit" class="btn btn-outline-info mb-2 flex-grow-1">Search Inventory</button>
      </form>
    </div>
  </nav>
  <!-- Form for adding Inventory 
  <div class="container-fluid">
  <div class="collapse" id="createFormCollapse">
  <form id="createForm" class="form-inline">
    <input type="text" id="yearInput" placeholder="Year" class="form-control mb-2 mr-sm-2 flex-grow-1" required>
    <input type="text" id="setInput" placeholder="Set" class="form-control mb-2 mr-sm-2" required>
    <input type="text" id="subsetInput" placeholder="Subset" class="form-control mb-2 mr-sm-2">
    <input type="text" id="playerInput" placeholder="Player" class="form-control mb-2 mr-sm-2">
    <input type="text" id="gradeInput" placeholder="Grade" class="form-control mb-2 mr-sm-2 flex-grow-1">
    <input type="date" id="txnDate" value="" class="form-control mb-2 mr-sm-2" required>
    <input type="number" step=".01" id="priceInput" placeholder="Price" class="form-control mb-2 mr-sm-2 flex-grow-1" required>
    <input type="text" id="itemtypeInput" placeholder="ItemType" list="ItemList" class="form-control mb-2 mr-sm-2 flex-grow-1" required>
      <datalist id="ItemList">
        <option value="Single"></option>
        <option value="Pack"></option>
        <option value="Box"></option>
        <option value="Case"></option>
      </datalist>
    <input type="text" id="txnsourceInput" placeholder="Source" list="TxnSourceList" class="form-control mb-2 mr-sm-2 flex-grow-1" required>
      <datalist id="TxnSourceList">
        <option value="eBay"></option>
        <option value="Blowout Forums"></option>
        <option value="/r/baseballcards"></option>
        <option value="Card Show"></option>
        <option value="Topps/Fanatics"></option>
        <option value="Auction House"></option>
      </datalist>
      <input type="file" class="form-control-custom mb-2 mr-sm-2" id="screenshotInput" accept=".jpg, .jpeg, .png">
    <button id="add-archived" type="submit" class="btn btn-primary mb-2 flex-grow-1">
      Add Inventory
    </button>

  </form>
  -->
  <!--
  <form id="bulkForm" class="form-inline">
    <input type="file" class="form-control-custom mb-2 mr-sm-2" id="csvInput" accept=".csv">
    <button id="bulk-add" type="submit" class="btn btn-primary mb-2">
      <span class="badge"><img src="../img/file-earmark-arrow-up.svg" alt="bulk upload"></span>
      Bulk
      <span class="sr-only">bulk upload inventory</span>
    </button>
  </form>
  </div>
  </div>
  end add inventory form -->
  <!-- Item Details Modal -->
    <div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Item Details</h5>
            <a href="javascript:void(0);" onclick="editRowsFunction()"><img class="locked" id="edit-table-rows-icon" src="../img/lock-fill.svg" width="30" height="30" alt="edit-table-rows-icon"></a>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="detailsForm">
              <div class="form-row mt-n1">
                <div class="form-group col-sm-12 mt-n1">
                  <label for="modal-guid">GUID</label>
                  <input type="text" class="form-control" id="modal-guid" value="" readonly>
                </div>
              </div>
            
              <div class="form-row mt-n1">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-Year">Year</label>
                  <input type="text" class="form-control" id="modal-Year" value="" readonly>
                </div>
                <div class="form-group col-sm-8 mt-n1">
                  <label for="modal-Set">Set</label>
                  <input type="text" class="form-control" id="modal-Set" value="" readonly>
                </div>
              </div>
            
              <div class="form-row mt-n1">
                <div class="form-group col-sm-8 mt-n1">
                  <label for="modal-Subset">Subset</label>
                  <input type="text" class="form-control" id="modal-Subset" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-CardNum">Card number</label>
                  <input type="text" class="form-control" id="modal-CardNum" value="" readonly>
                </div>
              </div>
            
              <div class="form-row mt-n1">
                <div class="form-group col-sm-6 mt-n1">
                  <label for="modal-PlayerName">Player Name</label>
                  <input type="text" class="form-control" id="modal-PlayerName" value="" readonly>
                </div>
                <div class="form-group col-sm-2 mt-n1">
                  <label for="modal-Qty">Qty</label>
                  <input type="text" class="form-control" id="modal-Qty" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-SerialNumber">Serial number</label>
                  <input type="text" class="form-control" id="modal-SerialNumber" value="" readonly>
                </div>
              </div>
            
              <div class="form-row mt-n1">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-Authenticator">Authenticator</label>
                  <input type="text" class="form-control" id="modal-Authenticator" value="" readonly>
                </div>
                <div class="form-group col-sm-2 mt-n1">
                  <label for="modal-Grade">Grade</label>
                  <input type="text" class="form-control" id="modal-Grade" value="" readonly>
                </div>
                <div class="form-group col-sm-6 mt-n1">
                  <label for="modal-CertNumber">Cert number</label>
                  <input type="text" class="form-control" id="modal-CertNumber" value="" readonly>
                </div>
              </div>
            
              <div class="form-row mt-n1">
                <div class="form-group col-sm-8 mt-n1">
                  <label for="modal-TxnId">Transaction ID</label>
                  <input type="text" class="form-control" id="modal-TxnId" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-eBayItemId">eBay item</label>
                  <input type="text" class="form-control" id="modal-eBayItemId" value="" readonly>
                </div>
              </div>
            
              <div class="form-row mt-n1">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-PurchasePrice">Purchase price</label>
                  <input type="text" class="form-control" id="modal-PurchasePrice" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-SalePrice">Sale price</label>
                  <input type="text" class="form-control" id="modal-SalePrice" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-GradingFee">Grading fee</label>
                  <input type="text" class="form-control" id="modal-GradingFee" value="" readonly>
                </div>
              </div>
            
              <div class="form-row mt-n1">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-TxnSource">Transaction source</label>
                  <input type="text" class="form-control" id="modal-TxnSource" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-TxnType">Transaction type</label>
                  <input type="text" class="form-control" id="modal-TxnType" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-TxnDate">Transaction date</label>
                  <input type="text" class="form-control" id="modal-TxnDate" value="" readonly>
                </div>
              </div>
              <button type="button" class="btn btn-warning" id="modal-update-button">Update</button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="modal-delete-button">Delete</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  <!-- End Item Details Modal -->
  <!-- Add Inventory Modal -->
    <div class="modal fade" id="staticBackdropAddInventory" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropAddInventoryLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropAddInventoryLabel">Item Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="createForm">
              <div class="form-row">
                <div class="col-3">
                  <input type="text" id="yearInput" placeholder="Year" class="form-control mb-2 mr-sm-2 flex-grow-1" required>
                </div>
                <div class="col">
                  <input type="text" id="setInput" placeholder="Set" class="form-control mb-2 mr-sm-2" required>
                </div>
              </div>
              <div class="form-row">
                <div class="col-7">
                  <input type="text" id="subsetInput" placeholder="Subset" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="text" id="cardNumInput" placeholder="Card #" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="text" id="serialNumberInput" placeholder="Serial #" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
              <div class="form-row">
                <div class="col-7">
                  <input type="text" id="playerInput" placeholder="Player(s)" class="form-control mb-2 mr-sm-2" required>
                </div>
                <div class="col">
                  <input type="number" id="qtyInput" placeholder="Qty" class="form-control mb-2 mr-sm-2" required>
                </div>
              </div>
              <div class="form-row">
                <div class="col">
                  <input type="text" id="authenticatorInput" placeholder="Authenticator" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="number" id="gradeInput" placeholder="Grade" class="form-control mb-2 mr-sm-2 flex-grow-1">
                </div>
                <div class="col">
                  <input type="text" id="certNumberInput" placeholder="Cert #" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
              <div class="input-group mb-2 mr-sm-2">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <a href="#" onclick="generateUUID()">
                        <img src="../img/arrow-repeat.svg">
                    </a>
                  </span>
                </div>
                <input type="text" id="txnIdInput" placeholder="Txn ID" class="form-control">
              </div>
              <input type="text" id="txnTypeInput" placeholder="Txn Type" value="Purchase" class="form-control mb-2 mr-sm-2">
              <div class="form-row">
                <div class="col">
                  <input type="text" id="txnSourceInput" placeholder="Source" list="TxnSourceList" class="form-control mb-2 mr-sm-2 flex-grow-1">
                  <datalist id="TxnSourceList">
                    <option value="eBay"></option>
                    <option value="Blowout Forums"></option>
                    <option value="/r/baseballcards"></option>
                    <option value="Card Show"></option>
                    <option value="Topps/Fanatics"></option>
                    <option value="Auction House"></option>
                  </datalist>
                </div>
                <div class="col">
                  <input type="text" id="eBayItemIdInput" placeholder="eBay Item Id" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
              <div class="form-row">
                <div class="col">
                  <input type="number" id="purchasePriceInput" step=".01" placeholder="Purchase Price" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="date" id="txnDate" value="" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
              <div class="form-row">
                <div class="col">
                  <input type="number" id="gradingFeeInput" placeholder="Grading Fee" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="number" id="salePriceInput" placeholder="Sale Price" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
                <button id="add-archived" type="submit" class="btn btn-primary mb-2 flex-grow-1">
                  Add Inventory
                </button>
              </form>
          </div>
          <div class="modal-footer">
            <form id="bulkForm" class="form-inline">
              <input type="file" class="form-control-custom mr-sm-2" id="csvInput" accept=".csv">
              <button id="bulk-add" type="submit" class="btn btn-primary">
                <span class="badge"><img src="../img/file-earmark-arrow-up.svg" alt="bulk upload"></span>
                Bulk
                <span class="sr-only">bulk upload inventory</span>
              </button>
            </form>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  <!-- End Add Inventory Modal -->
  <div class="container-fluid">
    <div class="input-group">
      <div class="input-group-prepend">
          <div class="form-group">
            <select class="custom-select custom-select-lg" id="tableFilterSelect">
              <option selected value="column5">Player</option>
              <option value="column1">Year</option>
              <option value="column2">Set</option>
              <option value="column3">Subset</option>
              <option value="column4">CardNum</option>
              <option value="column6">Qty</option>
            </select>
          </div>
      </div>
        <input type="text" id="tableFilter" onkeyup="tableFilterFunction()" placeholder="Filter results" class="form-control form-control-lg mb-3" aria-label="Text input with dropdown button">
        <button type="button" class="btn btn-primary mb-3" onclick="tableToCSV()">
          <span class="badge"><img src="../img/file-earmark-arrow-down.svg" alt="download results"></span>
          Results <span class="badge badge-light" id="num-results">0</span>
          <span class="sr-only">number of results returned</span>
        </button>
    </div>
  </div>
  <div class="limiter">
  <div class="container-table100">
  <div class="table100 w-100">
  <div>
  <table id="itemsTable">
    <thead>
      <tr class="table100-head">
        <th scope="col" class="column0" hidden>guid</th>
        <th scope="col" class="column1">Year</th>
        <th scope="col" class="column2">Set</th>
        <th scope="col" class="column3">Subset</th>
        <th scope="col" class="column4">CardNum</th>
		    <th scope="col" class="column5">Player</th>
        <th scope="col" class="column6">Qty</th>
        <th scope="col" class="column7">Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  </div>
  </div>
  </div>
  <script src="../vendor/jquery/jquery-3.2.1.min.js"></script>
  <script src="../vendor/bootstrap/js/popper.js"></script>
  <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="../vendor/select2/select2.min.js"></script>
  <script src="../js/main.js"></script>
  <script>
	let accessToken = localStorage.getItem('accessToken');
  </script>
  <script>
    /*
    function toggleSetPlayer() {
      const setSearch = 'document.getElementById("setSearchList")';
      const playerSearch = 'document.getElementById("playerSearchList")';
      if (!Boolean(document.getElementById("setSearchList").classList.contains('d-none'))) {
        // case: first toggle hit. Add the class d-none first
        document.getElementById("setSearchList").classList.add('d-none');
        // playerSearchList can toggle immediately because it defaults to d-none
        document.getElementById("playerSearchList").classList.toggle('d-none');
      } else {
        // case: hitting the toggle n + 1 times
        document.getElementById("playerSearchList").classList.toggle('d-none');
        document.getElementById("setSearchList").classList.toggle('d-none');
      }

    }
    */
    function generateUUID() {
      document.getElementById('txnIdInput').value = crypto.randomUUID();
    }
    function tableFilterFunction() {
      // https://www.w3schools.com/howto/howto_js_filter_table.asp
      // https://stackoverflow.com/a/1085810
      // Declare variables
      var input, filter, table, tr, td, i, txtValue, columnSelect;
      columns = document.getElementById("tableFilterSelect");
      columnSelect = columns.value;
      input = document.getElementById("tableFilter");
      filter = input.value.toUpperCase();
      table = document.getElementById("itemsTable");
      tr = table.getElementsByTagName("tr");
      searchCounter = 0;
      // Loop through all table rows, and hide those who don't match the search query
      for (i = 1; i < tr.length; i++) { // starting at 1 to exclude header
        td = tr[i].getElementsByClassName(columnSelect)[0];
        if (td) {
          txtValue = td.textContent || td.innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
            searchCounter++;
          } else {
            tr[i].style.display = "none";
          }
        }
      }
      document.getElementById('num-results').innerHTML = searchCounter;
    }
    </script>
  <script>
    function editRowsFunction() {
      var editicon = document.getElementById("edit-table-rows-icon");
      const container = document.querySelector("#detailsForm");
      if (editicon.classList.value == 'locked') {
        // case: default on page load
        //document.querySelectorAll("td[contenteditable='false']").forEach(elem => elem.setAttribute("contenteditable", "true"));
        //container.querySelectorAll("input[readonly]").forEach(elem => elem.removeAttribute("readonly"));
        container.querySelectorAll("input").forEach(elem => elem.readOnly = false);
        editicon.src = '../img/unlock-fill.svg'
        editicon.classList.value = 'unlocked'
        console.log("Rows unlocked for editing")
      } else {
        // locking after an unlock
        //document.querySelectorAll("td[contenteditable='true']").forEach(elem => elem.setAttribute("contenteditable", "false"));
        //container.querySelectorAll("input").forEach(elem => elem.setAttribute("readonly", true));
        container.querySelectorAll("input").forEach(elem => elem.readOnly = true);
        editicon.src = '../img/lock-fill.svg'
        editicon.classList.value = 'locked'
        console.log("Rows locked for editing")     
      }
    } // end editRowsFunction
  </script>
  <!--
  <script>
    function setDates(id, value) {
      // https://stackoverflow.com/a/14649259
      var dateField = document.getElementById(id);
      dateField.setAttribute("value", value);
    }
      // https://stackoverflow.com/a/13572682
      var today = new Date(), y = today.getFullYear(), m = today.getMonth();
      var beginMonth = new Date(y, m, 1);
    window.onload = function() {
      setDates("startDate",beginMonth.toLocaleDateString('fr-CA'));
      setDates("endDate",today.toLocaleDateString('fr-CA'));
      setDates("txnDate",today.toLocaleDateString('fr-CA'));
    }
  </script>
  -->
  <script>
    // Fetch existing items and populate the table on page load
    document.getElementById('existingForm').addEventListener('submit', function(event) {
        event.preventDefault();
      fetchItems();
    });
	
    // Event listener for the create form submission
    document.getElementById('createForm').addEventListener('submit', function(event) {
      event.preventDefault();
      createItem();
    });

    document.getElementById('bulkForm').addEventListener('submit', function(event) {
      event.preventDefault();
      bulkUpload();
    });

    // Control modal data population. Apparently these are positional parameters; gross.
    function openModal(guid, Year, Set, Subset, CardNum, PlayerName, Qty, SerialNumber, Authenticator, Grade, CertNumber, TxnId, eBayItemId, PurchasePrice, SalePrice, TxnDate, TxnSource, TxnType, GradingFee) {
      document.getElementById('modal-guid').value = guid;
      document.getElementById('modal-Year').value = Year;
      document.getElementById('modal-Set').value = Set;
      document.getElementById('modal-Subset').value = Subset;
      document.getElementById('modal-CardNum').value = CardNum;
      document.getElementById('modal-PlayerName').value = PlayerName;
      document.getElementById('modal-Qty').value = Qty;
      document.getElementById('modal-SerialNumber').value = SerialNumber;
      document.getElementById('modal-Authenticator').value = Authenticator;
      document.getElementById('modal-Grade').value = Grade;
      document.getElementById('modal-CertNumber').value = CertNumber;
      document.getElementById('modal-TxnId').value = TxnId;
      document.getElementById('modal-eBayItemId').value = eBayItemId;
      document.getElementById('modal-PurchasePrice').value = PurchasePrice;
      document.getElementById('modal-SalePrice').value = SalePrice;
      document.getElementById('modal-TxnDate').value = TxnDate;
      document.getElementById('modal-TxnSource').value = TxnSource;
      document.getElementById('modal-TxnType').value = TxnType;
      document.getElementById('modal-GradingFee').value = GradingFee;
      // You can add more code here to fetch and display other item details
      // set up Update button
      const updateButton = document.getElementById('modal-update-button');
      updateButton.onclick = function() {
        updateItem(guid)
      }
      // set up Delete button
      const deleteButton = document.getElementById('modal-delete-button');
      deleteButton.onclick = function() {
        deleteItem(guid);
        $('#staticBackdrop').modal('hide'); // Close the modal after deletion
      };
    }

    // Fetch existing items and populate the table    
    function sanitizeValue(value) {
        //return value === 'undefined' ? null : value;
        return value === 'undefined' || value === undefined ? '' : value;
    }
    function fetchItems() {
      var set = document.getElementById('setSearchList').value;
      var subset = document.getElementById('subsetSearchList').value;
      var qty = document.getElementById('qty').value;
      var year = document.getElementById('queryYear').value;
      var data = {
        Set: set,
        Year: year,
        Subset: subset,
        Qty: qty
      };
      console.log(data)
      fetch('https://api.us175.com/demo-query-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
	    .then(response => response.json())
        .then(data => {
          idnum = 0;
		      console.log(data)
          const itemsTable = document.getElementById('itemsTable');
          const tbody = itemsTable.getElementsByTagName('tbody')[0];
          document.getElementById('num-results').innerHTML = data.body.length;
          tbody.innerHTML = '';
          data.body.forEach(item => {
            // console.log(item)
            const row = document.createElement('tr');
		        row.classList.add("update-transition")
            row.id = 'row' + idnum; // uniquely identify each row for update/delete actions
            row.innerHTML = `
              <td class="column0" hidden>${sanitizeValue(item.guid)}</td>
              <td class="column1 mb-2 mb-lg-4" contenteditable="false">${sanitizeValue(item.Year)}</td>
              <td class="column2 mb-2 mb-lg-4" contenteditable="false">${sanitizeValue(item.Set)}</td>
              <td class="column3 mb-2 mb-lg-4" contenteditable="false">${sanitizeValue(item.Subset) || '<br>'}</td>
              <td class="column4 mb-2 mb-lg-4" contenteditable="false">${sanitizeValue(item.CardNum)}</td>
              <td class="column5 mb-2 mb-lg-4" contenteditable="false">${sanitizeValue(item.PlayerName)}</td>
              <td class="column6 mb-2 mb-lg-4" contenteditable="false">${sanitizeValue(item.Qty)}</td>
              <td class="column11 p-3 mt-3 d-flex flex-column d-lg-block mt-lg-0 p-lg-2">
                <a href="#" class="btn btn-info btn-sm" onclick="openModal(
                  '${sanitizeValue(item.guid)}',
                  '${sanitizeValue(item.Year)}',
                  '${sanitizeValue(item.Set)}',
                  '${sanitizeValue(item.Subset)}',
                  '${sanitizeValue(item.CardNum)}',
                  '${sanitizeValue(item.PlayerName)}',
                  '${sanitizeValue(item.Qty)}',
                  '${sanitizeValue(item.SerialNumber)}',
                  '${sanitizeValue(item.Authenticator)}',
                  '${sanitizeValue(item.Grade)}',
                  '${sanitizeValue(item.CertNumber)}',
                  '${sanitizeValue(item.TxnId)}',
                  '${sanitizeValue(item.eBayItemId)}',
                  '${sanitizeValue(item.PurchasePrice)}',
                  '${sanitizeValue(item.SalePrice)}',
                  '${sanitizeValue(item.TxnDate)}',
                  '${sanitizeValue(item.TxnSource)}',
                  '${sanitizeValue(item.TxnType)}',
                  '${sanitizeValue(item.GradingFee)}'
                  )" data-toggle="modal" data-target="#staticBackdrop">Details
                </a>
              </td>
            `;
            tbody.appendChild(row);
            ++idnum;
          });
        })
        .catch(error => console.error('Error:', error));
        //document.getElementById('setSearchList').value = ''; // clear it out
        //document.getElementById('subsetSearchList').value = '';
    }

    // Create a new item
    function createItem() {
      document.getElementById("add-archived").innerHTML = 'Loading...';
      const element = '<span id="add-archived-spin" class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>';
      document.getElementById("add-archived").insertAdjacentHTML("afterbegin",element);
      // document.getElementById("add-archived-spin").classList.remove('invisible');
      const year = document.getElementById('yearInput').value;
      const set = document.getElementById('setInput').value;
      const subset = document.getElementById('subsetInput').value;
      const cardnum = document.getElementById('cardNumInput').value;
      const player = document.getElementById('playerInput').value;
      const qty = document.getElementById('qtyInput').value;
      const serialnumber = document.getElementById('serialNumberInput').value;
      const authenticator = document.getElementById('authenticatorInput').value;
      const grade = document.getElementById('gradeInput').value;
      const certnumber = document.getElementById('certNumberInput').value;
      const txnid = document.getElementById('txnIdInput').value;
      const ebayitemid = document.getElementById('eBayItemIdInput').value;
      const purchaseprice = document.getElementById('purchasePriceInput').value;
      const saleprice = document.getElementById('salePriceInput').value;
      const txndate = document.getElementById('txnDate').value;
      const txnsource = document.getElementById('txnSourceInput').value;
      const txntype = document.getElementById('txnTypeInput').value;
      const gradingfee = document.getElementById('gradingFeeInput').value;
      
      const data = {
        Year: year,
        Set: set,
        Subset: subset,
        CardNum: cardnum,
        PlayerName: player,
        Qty: qty,
        SerialNumber: serialnumber,
        Authenticator: authenticator,
        Grade: grade,
        CertNumber: certnumber,
        TxnId: txnid,
        eBayItemId: ebayitemid,
        PurchasePrice: purchaseprice,
        SalePrice: saleprice,
        TxnDate: txndate,
        TxnSource: txnsource,
        TxnType: txntype,
        GradingFee: gradingfee
      };

      fetch('https://api.us175.com/demo-receive-event-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Item created:', data);
        // fetchItems(); // Refresh the table
        statusCode = data.StatusCode;
        if (statusCode =='200') {
          document.getElementById("add-archived").innerHTML = 'Success';
          document.getElementById("add-archived").classList.remove('btn-primary');
          document.getElementById("add-archived").classList.add('btn-success');
          setTimeout(function() {
            // reset button to normal status after 2 seconds
            document.getElementById("add-archived").classList.remove('btn-success');
            document.getElementById("add-archived").classList.add('btn-primary');
            document.getElementById("add-archived").innerHTML = 'Add Archived Price';
            // document.getElementById("add-archived-spin").classList.add('invisible');
          }, 2000);
        } else {
          document.getElementById("add-archived").innerHTML = 'Error';
          document.getElementById("add-archived").classList.remove('btn-primary');
          document.getElementById("add-archived").classList.add('btn-danger');
        };
        document.getElementById('createForm').reset(); // Reset the form
      })
      .catch(error => console.error('Error:', error));
    } // end createItem

    // Bulk upload inventory
    function bulkUpload() {
      const data = {
        CSVFile: window.b64CSV
      };
      fetch('https://api.us175.com/demo-bulk-upload-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Bulk data added', data);
        statusCode = data.StatusCode;
        if (statusCode =='200') {
          console.log('Bulk load success')
        } else {
          console.log('Bulk load error')
        };
      })
      .catch(error => console.error('Error:', error));
    } // end bulkUpload

    // Update an existing item
    function updateItem(guid) {
      var rows = document.getElementsByClassName("column0");
      // find the row that the guid belongs to so that we can set the background color
      for (let z = 0; z < rows.length; z++) {
        if (rows[z].innerHTML == guid) {
            rowId = rows[z].parentElement.id
            break;
        }
      }
      const updaterow = document.getElementById(rowId);
      // If Enter is accidentally pressed, <br> is added & must be sanitized
      const Guid = document.getElementById('modal-guid').value
      const year = document.getElementById('modal-Year').value.replaceAll('<br>','').replaceAll('undefined','');
      const set = document.getElementById('modal-Set').value.replaceAll('<br>','').replaceAll('undefined','');
      const subset = document.getElementById('modal-Subset').value.replaceAll('<br>','').replaceAll('undefined','');
      const cardnum = document.getElementById('modal-CardNum').value.replaceAll('<br>','').replaceAll('undefined','');
      const player = document.getElementById('modal-PlayerName').value.replaceAll('<br>','').replaceAll('undefined','');
      const qty = document.getElementById('modal-Qty').value.replaceAll('<br>','').replaceAll('undefined','');
      const serialnumber = document.getElementById('modal-SerialNumber').value.replaceAll('<br>','').replaceAll('undefined','');
      const authenticator = document.getElementById('modal-Authenticator').value.replaceAll('<br>','').replaceAll('undefined','');
      const grade = document.getElementById('modal-Grade').value.replaceAll('<br>','').replaceAll('undefined','');
      const certnumber = document.getElementById('modal-CertNumber').value.replaceAll('<br>','').replaceAll('undefined','');
      const txnid = document.getElementById('modal-TxnId').value.replaceAll('<br>','').replaceAll('undefined','');
      const ebayitemid = document.getElementById('modal-eBayItemId').value.replaceAll('<br>','').replaceAll('undefined','');
      const purchaseprice = document.getElementById('modal-PurchasePrice').value.replaceAll('<br>','').replaceAll('undefined','');
      const saleprice = document.getElementById('modal-SalePrice').value.replaceAll('<br>','').replaceAll('undefined','');
      const txndate = document.getElementById('modal-TxnDate').value.replaceAll('<br>','').replaceAll('undefined','');
      const txnsource = document.getElementById('modal-TxnSource').value.replaceAll('<br>','').replaceAll('undefined','');
      const txntype = document.getElementById('modal-TxnType').value.replaceAll('<br>','').replaceAll('undefined','');
      const gradingfee = document.getElementById('modal-GradingFee').value.replaceAll('<br>','').replaceAll('undefined','');
      const data = {
        guid: Guid,
        Year: year,
        Set: set,
        Subset: subset,
        CardNum: cardnum,
        PlayerName: player,
        Qty: qty,
        SerialNumber: serialnumber,
        Authenticator: authenticator,
        Grade: grade,
        CertNumber: certnumber,
        TxnId: txnid,
        eBayItemId: ebayitemid,
        PurchasePrice: purchaseprice,
        SalePrice: saleprice,
        TxnDate: txndate,
        TxnSource: txnsource,
        TxnType: txntype,
        GradingFee: gradingfee
      };
      console.log('Update item with ID:', guid);
      console.log(data);
      fetch('https://api.us175.com/demo-update-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Item updated:', data);
        // fetchItems(); // Refresh the table
        statusCode = data.StatusCode;
        if (statusCode == '200') {
          editRowsFunction() // re-lock fields
          updaterow.style.backgroundColor = "#28a745";
          //updaterow.style.background = "linear-gradient(to top, lime, 20%, cyan)";
          setTimeout(() => {
            updaterow.style.background = "";
          }, 750);
          console.log('Updated rowId:' + rowId + ' HTTP status: ' + statusCode);
          //document.getElementById(rowId).outerHTML = '';
        } else {
		      updaterow.style.backgroundColor = "#dc3545";
          //updaterow.style.background = "linear-gradient(to top, coral, 20%, crimson)"
		      setTimeout(() => {
            updaterow.style.backgroundColor = "";
          }, 750);
          //document.getElementById(rowId).innerHTML = 'Error';
          console.log('Error updating' + rowId + ' HTTP error: ' + statusCode)
        };
      })
      .catch(error => console.error('Error:', error));
    } // end updateItem

    // Delete an item
    function deleteItem(guid) {
      // Implement the delete logic based on your API endpoint
      var rows = document.getElementsByClassName("column0");
      // find the row that the guid belongs to so that we can delete from the DOM after success
      for (let z = 0; z < rows.length; z++) {
        if (rows[z].innerHTML == guid) {
            rowId = rows[z].parentElement.id
            break;
        }
      }
      const data = {
        guid: guid,
      };
      console.log('Delete item with ID:', guid);
      fetch('https://api.us175.com/demo-delete-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Item deleted:', data);
        // fetchItems(); // Refresh the table
        statusCode = data.StatusCode;
        if (statusCode == '200') {
          console.log('Deleting rowId:' + rowId);
          document.getElementById(rowId).outerHTML = '';
          console.log(statusCode)
        } else {
          //document.getElementById(rowId).innerHTML = 'Error';
          console.log(statusCode)
        };
      })
      .catch(error => console.error('Error:', error));
    } // end deleteItem

    function fetchSets() {
      fetch('sets.json', {
		  method: 'GET'
      })
      .then(response => response.json()
        .then(data => {
          console.log(data);
          var list = document.getElementById('setSearchList');
          data.Sets.forEach(item => {
            const option = document.createElement('option');
            //option.value = item;
            option.innerHTML = `
              <option value="${item}">${item}</td>
            `
            list.appendChild(option);
          })
        }
        )
      )
    } // end fetchSets
    function fetchSubsets() {
      fetch('subsets.json', {
		  method: 'GET'
      })
      .then(response => response.json()
        .then(data => {
          console.log(data);
          var list = document.getElementById('subsetSearchList');
          data.Subsets.forEach(item => {
            const option = document.createElement('option');
            //option.value = item;
            option.innerHTML = `
              <option value="${item}">${item}</td>
            `
            list.appendChild(option);
          })
        }
        )
      )
    } // end fetchSubsets
    document.addEventListener("DOMContentLoaded", function () {
      fetchSets();
      fetchSubsets();
    });
    /*
    function convertImageToBase64() {
      // https://stackoverflow.com/a/65926546
      const fileSelector = document.getElementById('screenshotInput');
      fileSelector.addEventListener('change', (event) => {
        const fileList = event.target.files[0];
        // console.log(fileList);
        // encode the file using the FileReader API
        const reader = new FileReader();
        reader.onloadend = () => {
          // use a regex to remove data url part
          const base64String = reader.result
          window.mimetype = base64String.match(/image\/\w+/)[0]
          console.log(window.mimetype)
          // console.log(base64String);
          window.b64Image = base64String
            .replace('data:', '')
            .replace(/^.+,/, '');
        };
        reader.readAsDataURL(fileList);
      });
    }
    convertImageToBase64();
    */
    function convertCSVToBase64() {
      // https://stackoverflow.com/a/65926546
      // Cg== is a newline character that is inadvertently added; no harm.
      const fileSelector = document.getElementById('csvInput');
      fileSelector.addEventListener('change', (event) => {
        const fileList = event.target.files[0];
        console.log(fileList);
        // encode the file using the FileReader API
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64String = reader.result
          //window.mimetype = base64String.match(/image\/\w+/)[0]
          //console.log(window.mimetype)
          window.b64CSV = base64String
            .replace('data:text/csv;base64,','');
          console.log(window.b64CSV);
        };
        reader.readAsDataURL(fileList);
      });
    }
    convertCSVToBase64();
  </script>
  <script>
    function tableToCSV() {
        // Variable to store the final csv data
        let csv_data = [];
        // Get each row data
        let rows = document.getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            // Get each column data
            let cols = rows[i].querySelectorAll('td,th');
            // Stores each csv row data
            let csvrow = [];
            for (let j = 0; j < cols.length - 1; j++) { // exclude button column
                // Get the text data of each cell of a row and push it to csvrow
                csvrow.push(cols[j].innerText);
            }
            // Combine each column value with comma
            csv_data.push(csvrow.join(","));
        }
        // Combine each row data with new line character
        csv_data = csv_data.join('\n');
        // Call this function to download csv file  
        downloadCSVFile(csv_data);
    }

    function downloadCSVFile(csv_data) {
        // Create CSV file object and feed our csv_data into it
        CSVFile = new Blob([csv_data], {
            type: "text/csv"
        });
        // Create to temporary link to initiate download process
        let temp_link = document.createElement('a');
        // Name csv file
        var elements = [];
        var setYear = document.getElementById('queryYear').value;
        if (setYear) {elements.push(setYear)};
        var setName = document.getElementById('setSearchList').value;
        if (setName) {elements.push(setName)};
        var subsetName = document.getElementById('subsetSearchList').value;
        if (subsetName) {elements.push(subsetName)};
        var setQty = document.getElementById('qty').value;
        if (setQty === '1') {
          elements.push('In-Inventory')
        } else if (setQty === '0') {
          elements.push('Missing')
        };
        var csvName = elements.join('-');
        // Download csv file
        temp_link.download = csvName + '.csv';
        let url = window.URL.createObjectURL(CSVFile);
        temp_link.href = url;
        // This link should not be displayed
        temp_link.style.display = "none";
        document.body.appendChild(temp_link);
        // Automatically click the link to trigger download
        temp_link.click();
        document.body.removeChild(temp_link);
    }
  </script>
</body>
</html>
