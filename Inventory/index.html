<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>US175 Inventory</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <script src="js/searchandfilter.js" defer></script>
  <script src="js/lookups.js" defer></script>
  <script src="js/viewselector.js" defer></script>
  <script src="js/importCSV.js" defer></script>
  <script src="js/exportCSV.js" defer></script>
  <script src="js/utilities.js" defer></script>
  <link rel="manifest" href="public/manifest.webmanifest">
  <link rel="icon" href="public/favicon.ico" sizes="any">
  <link rel="icon" href="public/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="public/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="public/apple-touch-icon-iphone-retina.png">
  <link rel="apple-touch-icon" sizes="120x120" href="public/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="120x120" href="public/apple-touch-icon-120x120-precomposed.png">
  <link rel="stylesheet" type="text/css" href="../vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="../css/util.css">
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" type="text/css" href="../fonts/font-awesome-4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="../vendor/animate/animate.css">
  <link rel="stylesheet" type="text/css" href="../vendor/select2/select2.min.css">
  <link rel="stylesheet" type="text/css" href="../vendor/perfect-scrollbar/perfect-scrollbar.css">
  <style>
	.update-transition {
        	transition: all 100ms ease-out;
	}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">
      <img src="public/icon.svg" width="30" height="30" class="d-inline-block align-top" alt="us175-price-archive-icon">
      US175
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto align-items-center">
        <li class="nav-item active">
          <a class="nav-link text-nowrap" href="https://test.us175.com/Inventory/">Inventory <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://test.us175.com/PriceArchive/">Price Archive</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gallery.us175.com/">Gallery</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://inv.us175.com/wantlist/">Wantlist</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://inv.us175.com/landing/">Landing</a>
        </li>
        <li class="mb-3 mb-lg-0">
          <button class="btn btn-outline-success my-2 my-sm-0 w-100" type="button" data-toggle="modal" data-target="#staticBackdropAddInventory">Update Inventory</button>
        </li>
      </ul>
      <!-- Form for searching existing transactions -->
      <form id="existingForm" class="form-inline">
        <button type="button" href="#" class="btn btn-outline*" data-toggle="modal" data-target="#staticBackdropBoxInfo">
          <img src="public/info.svg" width="20" height="20" class="d-inline-block align-top" alt="box-title-info" title="Box details">
        </button>
        <select class="d-none custom-select form-control mb-2 mr-sm-2" id="playerSearchList">
          <option id="list-player" selected value="">Select player...</option>
        </select>
        <select class="d-none custom-select form-control mb-2 mr-sm-2" id="boxSearchList">
          <option id="list-box" selected value="">Select box...</option>
        </select>
        <input class="queryInput form-control mb-2 mr-sm-2" type="text" id="queryYear" name="queryYear" title="Four digit year" pattern="^(20[0-9][0-9])$|(19[0-9][0-9])$" placeholder="2001">
        <select class="custom-select form-control mb-2 mr-sm-2 flex-grow-1" id="setSearchList">
          <option id="list-set" selected value="">Select set...</option>
        </select>
        <select class="custom-select form-control mb-2 mr-sm-2 flex-grow-1" id="subsetSearchList">
          <option id="list-subset" selected value="">Select subset...</option>
        </select>
        <input class="form-control mb-2 mr-sm-2" type="number" id="qty" name="qty" min="0" value="0" title="quantity">
        <button type="button" onclick="toggleSetPlayerBox()" class="btn btn-outline-dark mb-2 mr-2 flex-grow-1" id="toggleSearchButton">Search: Set</button>
        <button type="submit" class="btn btn-outline-info mb-2 flex-grow-1">Search Inventory</button>
      </form>
    </div>
  </nav>

  <!-- Item Details Modal -->
    <div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">Item Details</h5>
            <button type="button" class="btn btn-link p-0" onclick="editRowsFunction()" aria-label="Edit fields">
              <img class="locked" id="edit-table-rows-icon" src="../img/lock-fill.svg" width="30" height="30" alt="edit-table-rows-icon">
            </button>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="detailsForm">
              <div class="form-row mt-n1">
                <div class="form-group col-sm-8 mt-n1">
                  <label for="modal-guid">GUID</label>
                  <input type="text" class="form-control" id="modal-guid" value="" disabled>
                </div>
                <div class="form-group col-sm-2 mt-n1">
                  <label for="modal-image-gallery">Gallery</label>
                    <button type="button" href="#" class="btn btn-outline*" onclick="openImageGalleryFromDetails(); return false;">
                      <img src="public/image-icon.svg" width="40" height="25" class="d-inline-block align-top" alt="image-gallery-link" title="Image Gallery">
                    </button>
                </div>
                <div class="form-group col-sm-2 mt-n1">
                  <label for="modal-image-upload">Upload</label>
                    <button type="button" class="btn btn-outline*" onclick="openImageUploadFromDetails(); return false;">
                      <img src="public/file-earmark-image.svg" width="25" height="25" class="d-inline-block align-top" alt="upload-images" title="Upload Images">
                    </button>
                </div>
              </div>
              <div class="form-row mt-n1">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-Year">Year</label>
                  <input type="text" class="form-control" id="modal-Year" pattern="^[\d]{4}$" value="" readonly>
                </div>
                <div class="form-group col-sm-8 mt-n1">
                  <label for="modal-Set">Set</label>
                  <input type="text" class="form-control" id="modal-Set" value="" readonly>
                </div>
              </div>
              <div class="form-row mt-n1">
                <div class="form-group col-sm-8 mt-n1">
                  <label for="modal-Subset">Subset</label>
                  <input type="text" class="form-control" id="modal-Subset" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-CardNum">Card number</label>
                  <input type="text" class="form-control" id="modal-CardNum" value="" readonly>
                </div>
              </div>
              <div class="form-row mt-n1">
                <div class="form-group col-sm-6 mt-n1">
                  <label for="modal-PlayerName">Player Name</label>
                  <input type="text" class="form-control" id="modal-PlayerName" value="" readonly>
                </div>
                <div class="form-group col-sm-2 mt-n1">
                  <label for="modal-Qty">Qty</label>
                  <input type="text" class="form-control" id="modal-Qty" pattern="^[\d]{1,2}$" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-SerialNumber">Serial number</label>
                  <input type="text" class="form-control" id="modal-SerialNumber" value="" readonly>
                </div>
              </div>
              <div class="form-row mt-n1">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-Authenticator">Authenticator</label>
                  <input type="text" class="form-control" id="modal-Authenticator" pattern="(?:^PSA$)|(?:BGS$)|(?:SGC$)|(?:CGC$)" value="" readonly>
                </div>
                <div class="form-group col-sm-2 mt-n1">
                  <label for="modal-Grade">Grade</label>
                  <input type="text" class="form-control" pattern="^(?:[1-9](?:\.5)?|10)$" id="modal-Grade" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-CertNumber">Cert number</label>
                  <input type="text" class="form-control" id="modal-CertNumber" value="" readonly>
                </div>
                <div class="form-group col-sm-2 mt-n1">
                  <label for="modal-BoxNum">Box number</label>
                  <input type="text" class="form-control" id="modal-BoxNum" value="" required readonly>
                </div>
              </div>
              <div class="form-row mt-n1">
                <div class="form-group col-sm-8 mt-n1">
                  <label for="modal-TxnId">Transaction ID</label>
                  <div class="input-group">
                  	<div class="input-group-prepend">
                      <span class="input-group-text">
                        <a href="#" onclick="generateUUID('modal-TxnId'); return false;">
                            <img src="../img/arrow-repeat.svg" alt="generate new UUID">
                        </a>
                      </span>
                    </div>
                  <input type="text" class="form-control" id="modal-TxnId" value="" readonly>
                  </div>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-eBayItemId">eBay item</label>
                  <input type="text" class="form-control" id="modal-eBayItemId" value="" pattern="[\d]{12}" readonly>
                </div>
              </div>
              <div class="form-row mt-n1">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-PurchasePrice">Purchase price</label>
                  <input type="text" class="form-control" id="modal-PurchasePrice" pattern="(?:^[1-9]([0-9]+)?(?:\.[0-9]{1,2})?$)|(?:^(?:0)$)|(?:^[0-9]\.[0-9](?:[0-9])?$)" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-MktVal">Market Value</label>
                  <input type="text" class="form-control" id="modal-MktVal" pattern="(?:^[1-9]([0-9]+)?(?:\.[0-9]{1,2})?$)|(?:^(?:0)$)|(?:^[0-9]\.[0-9](?:[0-9])?$)" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-GradingFee">Grading fee</label>
                  <input type="text" class="form-control" id="modal-GradingFee" pattern="(?:^[1-9]([0-9]+)?(?:\.[0-9]{1,2})?$)|(?:^(?:0)$)|(?:^[0-9]\.[0-9](?:[0-9])?$)" value="" readonly>
                </div>
              </div>
              <div class="form-row mt-n1">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-TxnSource">Transaction source</label>
                  <input type="text" class="form-control" id="modal-TxnSource" list="TxnSourceList" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-TxnType">Transaction type</label>
                  <input type="text" class="form-control" id="modal-TxnType" list="TxnTypeList" value="" readonly>
                </div>
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-TxnDate">Transaction date</label>
                  <input type="date" class="form-control" id="modal-TxnDate" value="" readonly>
                </div>
              </div>
              <div class="form-row mt-n1">
                <button type="button" class="btn btn-link p-0" data-toggle="collapse" data-target="#modalSalesCollapse" aria-expanded="false" aria-controls="expand-sales-data">
                  <img src="public/plus.svg" width="20" height="20" alt="expand-sales-data">
                  <span class="label label-default">Sales Data</span>
                </button>
              </div>
              <hr class="mt-2 mb-3">
              <div class="form-row mt-n1 collapse" id="modalSalesCollapse">
                <div class="form-group col-sm-4 mt-n1">
                  <label for="modal-SalePrice">Sale price</label>
                  <input type="text" class="form-control" id="modal-SalePrice" pattern="(?:^[1-9]([0-9]+)?(?:\.[0-9]{1,2})?$)|(?:^(?:0)$)|(?:^[0-9]\.[0-9](?:[0-9])?$)" value="" readonly>
                </div>
              </div>
              <button type="submit" class="btn btn-warning" id="modal-update-button">Update</button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="modal-delete-button">Delete</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  <!-- End Item Details Modal -->
  <!-- Add Inventory Modal -->
    <div class="modal fade" id="staticBackdropAddInventory" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropAddInventoryLabel" aria-modal="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropAddInventoryLabel">Item Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="createForm">
              <div class="form-row">
                <div class="col-3">
                  <input type="text" id="yearInput" placeholder="Year" class="form-control mb-2 mr-sm-2 flex-grow-1" required>
                </div>
                <div class="col">
                  <input type="text" id="setInput" placeholder="Set" class="form-control mb-2 mr-sm-2" required>
                </div>
              </div>
              <div class="form-row">
                <div class="col-7">
                  <input type="text" id="subsetInput" placeholder="Subset" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="text" id="cardNumInput" placeholder="Card #" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="text" id="serialNumberInput" placeholder="Serial #" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
              <div class="form-row">
                <div class="col-7">
                  <input type="text" id="playerInput" placeholder="Player(s)" class="form-control mb-2 mr-sm-2" required>
                </div>
                <div class="col">
                  <input type="number" id="qtyInput" placeholder="Qty" class="form-control mb-2 mr-sm-2" required>
                </div>
              </div>
              <div class="form-row">
                <div class="col">
                  <input type="text" id="authenticatorInput" placeholder="Authenticator" pattern="(?:^PSA$)|(?:BGS$)|(?:SGC$)|(?:CGC$)" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="text" id="gradeInput" placeholder="Grade" pattern="^(?:[1-9](?:\.5)?|10)$" class="form-control mb-2 mr-sm-2 flex-grow-1">
                </div>
                <div class="col">
                  <input type="text" id="certNumberInput" placeholder="Cert #" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="text" id="boxNumInput" placeholder="Box #" class="form-control mb-2 mr-sm-2" required>
                </div>
              </div>
              <div class="input-group mb-2 mr-sm-2">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <a href="#" onclick="generateUUID('txnIdInput'); return false;">
                        <img src="../img/arrow-repeat.svg" alt="generate new UUID">
                    </a>
                  </span>
                </div>
                <input type="text" id="txnIdInput" placeholder="Txn ID" class="form-control">
              </div>
              <input type="text" id="txnTypeInput" placeholder="Txn Type" list="TxnTypeList" value="Purchase" class="form-control mb-2 mr-sm-2">
                <datalist id="TxnTypeList">
                  <option value="Purchase"></option>
                  <option value="Trade"></option>
                  <option value="Pulled"></option>
                </datalist>
              <div class="form-row">
                <div class="col">
                  <input type="text" id="txnSourceInput" placeholder="Source" list="TxnSourceList" class="form-control mb-2 mr-sm-2 flex-grow-1">
                  <datalist id="TxnSourceList">
                    <option value="eBay"></option>
                    <option value="Blowout Forums"></option>
                    <option value="/r/baseballcards"></option>
                    <option value="Card Show"></option>
                    <option value="Topps/Fanatics"></option>
                    <option value="Auction House"></option>
                  </datalist>
                </div>
                <div class="col">
                  <input type="text" id="eBayItemIdInput" placeholder="eBay Item Id" pattern="[\d]{12}" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
              <div class="form-row">
                <div class="col">
                  <input type="number" id="purchasePriceInput" step=".01" placeholder="Purchase Price" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="number" id="mktValInput" step=".01" placeholder="Market Value" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="date" id="txnDate" value="" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
              <div class="form-row">
                <div class="col">
                  <input type="number" id="gradingFeeInput" placeholder="Grading Fee" class="form-control mb-2 mr-sm-2">
                </div>
                <div class="col">
                  <input type="number" id="salePriceInput" placeholder="Sale Price" class="form-control mb-2 mr-sm-2">
                </div>
              </div>
                <button id="add-archived" type="submit" class="btn btn-primary mb-2 flex-grow-1">
                  Add Inventory
                </button>
              </form>
          </div>
          <div class="modal-footer">
            <div class="form-inline">
              <input type="file" class="form-control-custom mr-sm-2" id="csvInput" accept=".csv">
              <small id="csvMeta" class="mr-2 text-muted"></small>
              <button id="bulk-add" type="button" class="btn btn-primary" onclick="bulkUpload()" disabled>
                <span class="badge"><img src="../img/upload_icon.svg" width="20" height="20" alt="bulk upload"></span>
                Bulk
                <span class="sr-only">bulk upload inventory</span>
              </button>
            </div>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  <!-- End Add Inventory Modal -->
  <!-- Box Details Modal-->
  <div id="boxInfoModalMount"></div>
  <!-- End Box Details Modal-->
  <div class="container-fluid">
    <div class="input-group">
      <div class="input-group-prepend">
          <div class="form-group">
            <select class="custom-select custom-select-lg" id="tableFilterSelect">
              <option selected value="column5">Player</option>
              <option value="column1">Year</option>
              <option value="column2">Set</option>
              <option value="column3">Subset</option>
              <option value="column4">CardNum</option>
              <option value="column6">Qty</option>
            </select>
          </div>
      </div>
        <input type="text" id="tableFilter" onkeyup="tableFilterFunction()" placeholder="Filter results" class="form-control form-control-lg mb-3" aria-label="Text input with dropdown button">
        <button type="button" class="btn btn-primary mb-3" onclick="exportFullDataToCSV()">
          <span class="badge"><img src="../img/download_icon.svg" width="20" height="20" alt="download results"></span>
          Results <span class="badge badge-light" id="num-results">0</span>
          <span class="sr-only">number of results returned</span>
        </button>
        <div id="view-selector" class="btn-group ml-1" role="group" aria-label="Table view selectors">
          <button type="button" class="btn btn-secondary mb-3">Checklist</button>
          <button type="button" class="btn btn-info mb-3">Details</button>
          <button type="button" class="btn btn-success mb-3">Financial</button>
        </div>
    </div>
  </div>
  <div class="limiter">
    <div class="container-table100">
      <div class="table100 w-100">
        <div>
          <table id="itemsTable">
            <thead>
              <tr class="table100-head">
                <th scope="col" class="column0" hidden>guid</th>
                <th scope="col" class="column1">Year</th>
                <th scope="col" class="column2">Set</th>
                <th scope="col" class="column3">Subset</th>
                <th scope="col" class="column4">CardNum</th>
                <th scope="col" class="column5">Player</th>
                <th scope="col" class="column6">Qty</th>
                <th scope="col" class="column7">Action</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr class="table100-foot"></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script src="../vendor/jquery/jquery-3.2.1.min.js"></script>
  <script src="../vendor/bootstrap/js/popper.js"></script>
  <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="../vendor/select2/select2.min.js"></script>
  <script src="../js/main.js"></script>
  <script src="js/imageGallery.js"></script>
  <script src="js/imageUpload.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadLookups();
    });
  </script>

  <script>
    function editRowsFunction() {
      var editicon = document.getElementById("edit-table-rows-icon");
      const container = document.querySelector("#detailsForm");
      if (editicon.classList.value == 'locked') {
        // case: default on page load
        container.querySelectorAll("input").forEach(elem => elem.readOnly = false);
        editicon.src = '../img/unlock-fill.svg'
        editicon.classList.value = 'unlocked'
        console.log("Rows unlocked for editing")
      } else {
        // locking after an unlock
        container.querySelectorAll("input").forEach(elem => elem.readOnly = true);
        editicon.src = '../img/lock-fill.svg'
        editicon.classList.value = 'locked'
        console.log("Rows locked for editing")     
      }
    } // end editRowsFunction
  </script>
  <script>
    // Fetch existing items and populate the table on page load
    document.getElementById('existingForm').addEventListener('submit', function(event) {
        event.preventDefault();
      fetchItems();
    });
	
    // Event listener for the create form submission
    document.getElementById('createForm').addEventListener('submit', function(event) {
      event.preventDefault();
      createItem();
    });

    // openModal and updateItem helper functions
    function populateFromItem(item, fieldMap) {
      Object.entries(fieldMap).forEach(([key, elementId]) => {
        const el = document.getElementById(elementId);
        if (el) el.value = sanitize(item?.[key]);
      });
    }

    function collectFromModal(fieldMap) {
      return Object.fromEntries(
        Object.entries(fieldMap).map(([key, elementId]) => {
          const el = document.getElementById(elementId);
          return [key, sanitize(el?.value)];
        })
      );
    }

    let activeGuid = null;
    document.getElementById("detailsForm").addEventListener("submit", function (e) {
      e.preventDefault();
      if (!activeGuid) {
        console.warn("No active GUID set");
        return;
      }
      updateItem(activeGuid);
    });

    document.addEventListener('click', e => {
      const btn = e.target.closest('.details-btn');
      if (!btn) return;

      const index = btn.dataset.index;
      openModal(window.exportInventoryData[index]);
    });
    const modalFieldMap = {
      guid: 'modal-guid',
      Year: 'modal-Year',
      Set: 'modal-Set',
      Subset: 'modal-Subset',
      CardNum: 'modal-CardNum',
      PlayerName: 'modal-PlayerName',
      Qty: 'modal-Qty',
      SerialNumber: 'modal-SerialNumber',
      Authenticator: 'modal-Authenticator',
      Grade: 'modal-Grade',
      CertNumber: 'modal-CertNumber',
      BoxNum: 'modal-BoxNum',
      TxnId: 'modal-TxnId',
      eBayItemId: 'modal-eBayItemId',
      PurchasePrice: 'modal-PurchasePrice',
      SalePrice: 'modal-SalePrice',
      TxnDate: 'modal-TxnDate',
      TxnSource: 'modal-TxnSource',
      TxnType: 'modal-TxnType',
      GradingFee: 'modal-GradingFee',
      MktVal: 'modal-MktVal'
    };
    function openModal(item) {
      activeGuid = item.guid;
      populateFromItem(item, modalFieldMap); // call helper
      const deleteButton = document.getElementById('modal-delete-button');
      deleteButton.onclick = () => {
        deleteItem(activeGuid);
        $('#staticBackdrop').modal('hide');
      };
    }

    // Fetch existing items and populate the table    
    function fetchItems() {
      var set = document.getElementById('setSearchList').value;
      var subset = document.getElementById('subsetSearchList').value;
      var qty = document.getElementById('qty').value;
      var year = document.getElementById('queryYear').value;
      var boxnum = document.getElementById('boxSearchList').value;
      var playername = document.getElementById('playerSearchList').value;
      let data = {};
      if (set) {
        data = {
          Set: set,
          Year: year,
          Subset: subset,
          Qty: qty,
          SearchType: searchtype
        };
      } else if (boxnum) {
        data = {
          BoxNum: boxnum,
          SearchType: searchtype
        };
      } else if (playername) {
        data = {
          PlayerName: playername,
          SearchType: searchtype
        };
      }
      // console.log(data)
      fetch('https://api.us175.com/demo-query-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
	    .then(response => response.json())
        .then(data => {
          window.exportInventoryData = data.body;  // CSV + modal click uses this
          window.lastFetchedData = data;           // view switching uses this

          document.getElementById('num-results').textContent = data.body.length;

          populateTable(data);
        })
        .catch(error => console.error('Error:', error));
    }
    // Add Inventory button helper
    function setCreateButtonState(state) {
      const btn = document.getElementById("add-archived");
      if (!btn) return;

      // remove prior spinner if any
      btn.querySelector('#add-archived-spin')?.remove();

      if (state === "loading") {
        btn.classList.remove('btn-success', 'btn-danger');
        btn.classList.add('btn-primary');
        btn.innerHTML = 'Loading...';
        btn.insertAdjacentHTML(
          "afterbegin",
          '<span id="add-archived-spin" class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> '
        );
        btn.disabled = true;
        return;
      }

      btn.disabled = false;

      if (state === "success") {
        btn.innerHTML = 'Success';
        btn.classList.remove('btn-primary', 'btn-danger');
        btn.classList.add('btn-success');
        return;
      }

      if (state === "error") {
        btn.innerHTML = 'Error';
        btn.classList.remove('btn-primary', 'btn-success');
        btn.classList.add('btn-danger');
        return;
      }

      // default / reset
      btn.classList.remove('btn-success', 'btn-danger');
      btn.classList.add('btn-primary');
      btn.innerHTML = 'Add Inventory';
    }

    function createItem() {
      setCreateButtonState("loading");

      // Map payload keys -> input IDs
      const fields = {
        Year: 'yearInput',
        Set: 'setInput',
        Subset: 'subsetInput',
        CardNum: 'cardNumInput',
        PlayerName: 'playerInput',
        Qty: 'qtyInput',
        SerialNumber: 'serialNumberInput',
        Authenticator: 'authenticatorInput',
        Grade: 'gradeInput',
        CertNumber: 'certNumberInput',
        BoxNum: 'boxNumInput',
        TxnId: 'txnIdInput',
        eBayItemId: 'eBayItemIdInput',
        PurchasePrice: 'purchasePriceInput',
        MktVal: 'mktValInput',
        SalePrice: 'salePriceInput',
        TxnDate: 'txnDate',
        TxnSource: 'txnSourceInput',
        TxnType: 'txnTypeInput',
        GradingFee: 'gradingFeeInput'
      };

      const payload = Object.fromEntries(
        Object.entries(fields).map(([key, id]) => {
          const el = document.getElementById(id);
          return [key, sanitize(el?.value)];
        })
      );

      fetch('https://api.us175.com/demo-receive-event-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(res => {
          const statusCode = res.StatusCode;

          if (statusCode == '200') {
            setCreateButtonState("success");

            // reset button back to normal after 2 seconds
            setTimeout(() => setCreateButtonState("reset"), 2000);

            document.getElementById('createForm')?.reset();
            // optional: fetchItems(); // refresh table
          } else {
            setCreateButtonState("error");
            console.log('Create failed:', statusCode, res);
          }
        })
        .catch(err => {
          console.error('Error:', err);
          setCreateButtonState("error");
        });
    }

    // updateItem helper
    function setRowCell(row, colClass, value) {
      const td = row.querySelector(`td.${colClass}`);
      if (td) td.textContent = sanitize(value ?? '');
    }

    function updateCachedItem(guid, patch) {
      const g = String(guid);

      // update exportInventoryData (used for modal click + CSV)
      let idx = -1;
      if (Array.isArray(window.exportInventoryData)) {
        idx = window.exportInventoryData.findIndex(i => String(i?.guid) === g);
        if (idx !== -1) Object.assign(window.exportInventoryData[idx], patch);
      }

      // update lastFetchedData.body (used for view switching / re-render)
      if (window.lastFetchedData?.body) {
        // if we found idx above, use it; otherwise find it here
        if (idx === -1) {
          idx = window.lastFetchedData.body.findIndex(i => String(i?.guid) === g);
        }
        if (idx !== -1) Object.assign(window.lastFetchedData.body[idx], patch);
      }

      // return the updated item if we can (handy for callers)
      if (idx !== -1 && Array.isArray(window.exportInventoryData)) return window.exportInventoryData[idx];
      if (idx !== -1 && window.lastFetchedData?.body) return window.lastFetchedData.body[idx];
      return null;
    }

    // Update an existing item
    function updateItem(guid) {
      const updaterow = document.querySelector(
        `#itemsTable tbody tr[data-guid="${CSS.escape(String(guid))}"]`
      );
      if (!updaterow) {
        console.warn('Could not find table row for guid:', guid);
        return;
      }

      const payload = collectFromModal(modalFieldMap);

      fetch('https://api.us175.com/demo-update-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(res => {
          const statusCode = res.StatusCode;

          if (statusCode == '200') {
            editRowsFunction(); // re-lock fields

            // update caches with the payload, not the API response
            updateCachedItem(guid, payload);

            // patch visible row using the payload
            setRowCell(updaterow, 'column1', payload.Year);
            setRowCell(updaterow, 'column2', payload.Set);
            setRowCell(updaterow, 'column3', payload.Subset);
            setRowCell(updaterow, 'column4', payload.CardNum);
            setRowCell(updaterow, 'column5', payload.PlayerName);
            setRowCell(updaterow, 'column6', payload.Qty);

            if (currentView === 'details') {
              setRowCell(updaterow, 'column8', payload.Authenticator);
              setRowCell(updaterow, 'column9', payload.Grade);
              setRowCell(updaterow, 'column10', payload.CertNumber);
              setRowCell(updaterow, 'column11', payload.BoxNum);
              setRowCell(updaterow, 'column12', payload.SerialNumber);
            }

            if (currentView === 'financial') {
              setRowCell(updaterow, 'column8', payload.Authenticator);
              setRowCell(updaterow, 'column9', payload.Grade);
              setRowCell(updaterow, 'column10', payload.PurchasePrice);
              setRowCell(updaterow, 'column11', payload.GradingFee);
              setRowCell(updaterow, 'column12', payload.MktVal);
              setRowCell(updaterow, 'column13', payload.TxnSource);
            }

            // (optional) update mobile data-labels
            if (typeof applyMobileLabels === 'function') applyMobileLabels(updaterow);

            updaterow.style.backgroundColor = "#28a745";
            setTimeout(() => (updaterow.style.background = ""), 750);
          } else {
            updaterow.style.backgroundColor = "#dc3545";
            setTimeout(() => (updaterow.style.backgroundColor = ""), 750);
            console.log('Error updating', guid, 'HTTP error:', statusCode, res);
          }
        })
        .catch(err => console.error('Error:', err));
    }

    // Delete an item
    function deleteItem(guid) {
      const deleterow = document.querySelector(
        `#itemsTable tbody tr[data-guid="${CSS.escape(String(guid))}"]`
      );
      if (!deleterow) {
        console.warn('Could not find table row for guid:', guid);
        return;
      }
      const data = {
        guid: guid,
      };
      console.log('Delete item with ID:', guid);
      fetch('https://api.us175.com/demo-delete-inventory', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Item deleted:', data);
        statusCode = data.StatusCode;
        if (statusCode == '200') {
          console.log('Deleting guid:' + guid);
          deleterow.style.backgroundColor = "#dc3545";
          setTimeout(() => deleterow.remove(), 200);
          console.log(statusCode)
          const badge = document.getElementById('num-results');
          badge.textContent = Math.max(0, Number(badge.textContent) - 1);
          // fetchItems(); // Refresh the table
        } else {
          console.log(statusCode)
        };
      })
      .catch(error => console.error('Error:', error));
    } // end deleteItem
  </script>

  <script>
    async function loadPartial(url, targetId, onLoad) {
      const res = await fetch(url, { cache: 'force-cache' });
      if (!res.ok) throw new Error(`Failed to load ${url}: ${res.status}`);

      document.getElementById(targetId).insertAdjacentHTML('beforeend', await res.text());

      // run callback after HTML exists
      if (typeof onLoad === 'function') onLoad();
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadPartial('partials/box-details-modal.html', 'boxInfoModalMount')
        .catch(err => console.error(err));

      loadPartial('partials/image-gallery-modal.html', 'imageGalleryModalMount')
        .catch(err => console.error(err));

      // IMPORTANT: init after modal markup is injected
      loadPartial('partials/image-upload-modal.html', 'imageUploadModalMount', () => {
        window.initImageUploadModal?.();
      }).catch(err => console.error(err));
    });
  </script>
  <!-- Image Gallery Modal -->
  <div id="imageGalleryModalMount"></div>
  <!-- End Image Gallery Modal -->
  <!-- Image Upload Modal -->
  <div id="imageUploadModalMount"></div>
  <!-- End Image Upload Modal -->
</body>
</html>
