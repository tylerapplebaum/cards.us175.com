import boto3
from boto3.dynamodb.conditions import Key, Attr
import os
import json
import logging
import botocore
from natsort import natsorted

logger = logging.getLogger()
logger.setLevel(logging.INFO)

dynamodb = boto3.resource('dynamodb', region_name='us-east-2')
table = dynamodb.Table(os.environ.get('TableName'))

INDEX_SET_YEAR = os.environ.get('IndexName_SetYear', 'Set-Year-Index')
INDEX_BOX_PLAYER = os.environ.get('IndexName_BoxPlayer', 'BoxNum-PlayerName-Index')
INDEX_PLAYER_SET = os.environ.get('IndexName_PlayerSet', 'PlayerName-Set-Index')

def lambda_handler(event, context):
    logger.info(event['body'])
    bodyParsed = json.loads(event['body'])

    # Determine which index to use
    search_type = bodyParsed.get('SearchType', 'set').lower()  # default: set

    if search_type == 'box':
        index = INDEX_BOX_PLAYER
        KeyName = 'BoxNum'
        SortKeyName = 'PlayerName'
        KeyVal = bodyParsed.get('BoxNum', "")
        SortKeyVal = bodyParsed.get('PlayerName', "")
        LambdaSort = 'CardNum'
    elif search_type == 'player': # find cards where player is featured
        index = INDEX_PLAYER_SET
        KeyName = 'PlayerName'
        SortKeyName = 'Set'
        KeyVal = bodyParsed.get('PlayerName', "")
        SortKeyVal = bodyParsed.get('Set', "")
        LambdaSort = 'Year'
    else:
        index = INDEX_SET_YEAR
        KeyName = 'Set'
        SortKeyName = 'Year'
        KeyVal = bodyParsed.get('Set', "")
        SortKeyVal = bodyParsed.get('Year', "")
        LambdaSort = 'CardNum'

    AttrName1 = 'Subset'
    AttrVal1 = bodyParsed.get('Subset', "")
    AttrName2 = 'Qty'
    AttrVal2 = int(bodyParsed.get('Qty', "0"))

    logger.info(f"Using Index: {index}")

    def ddbquery():
        lastEvaluatedKey = None
        key_condition_expression = Key(KeyName).eq(KeyVal)
        if SortKeyVal != "":
            key_condition_expression &= Key(SortKeyName).eq(SortKeyVal)

        filter_expression = None
        if AttrVal1:
            filter_expression = Attr(AttrName1).eq(AttrVal1)
        if AttrVal2 != 0:
            filter_expression = (
                Attr(AttrName2).eq(AttrVal2)
                if not filter_expression
                else filter_expression & Attr(AttrName2).eq(AttrVal2)
            )

        items = []
        while True:
            query_params = {
                'IndexName': index,
                'ScanIndexForward': False,
                'KeyConditionExpression': key_condition_expression
            }
            if filter_expression:
                query_params['FilterExpression'] = filter_expression
            if lastEvaluatedKey:
                query_params['ExclusiveStartKey'] = lastEvaluatedKey

            resp = table.query(**query_params)
            items.extend(resp['Items'])

            if 'LastEvaluatedKey' in resp:
                lastEvaluatedKey = resp['LastEvaluatedKey']
            else:
                break

        itemsListSorted = natsorted(items, key=lambda d: d.get(LambdaSort, ''))
        return itemsListSorted

    try:
        ddbitems = ddbquery()
    except botocore.exceptions.ClientError as error:
        raise error

    responseObject = {
        'StatusCode': 200,
        'headers': {'Content-Type': 'application/json'},
        'body': ddbitems
    }
    
    return responseObject

